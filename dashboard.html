<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale Ledger Pro</title>
    <style>
        :root { --bg: #f8f9fa; --card-bg: #ffffff; --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --text: #2d3436; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; }
        .container { max-width: 1300px; margin: auto; }
        
        .header { background: var(--primary); color: white; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn { padding: 10px 15px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; }
        .btn-blue { background: var(--accent); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--danger); color: white; }

        /* MOBILE TABLE FIX */
        .table-wrapper { width: 100%; overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; } /* Min-width ensures columns don't squash */
        th { background: #f1f3f5; padding: 12px; font-size: 12px; text-transform: uppercase; color: #495057; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f5; text-align: center; }
        
        input { padding: 8px; border: 1px solid #dee2e6; border-radius: 6px; width: 80px; }
        .prod-tag { font-size: 11px; background: #e9ecef; padding: 4px; border-radius: 4px; display: inline-block; margin: 2px; border: 1px solid #ced4da; }

        .customer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .customer-card { background: var(--card-bg); border-radius: 15px; padding: 20px; border: 1px solid #e0e0e0; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 400px; margin: 50px auto; padding: 25px; border-radius: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div id="selectionScreen">
        <div class="header">
            <div>
                <h1 style="margin:0; font-size: 18px;">Wholesale Manager</h1>
                <span style="font-size:12px;">Owner: <b id="ownerDisplay"></b></span>
            </div>
            <button class="btn btn-red" onclick="logout()">Logout</button>
        </div>

        <div id="customerList" class="customer-grid"></div>

        <div style="margin-top: 30px; text-align: center; display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-blue" onclick="openCustModal(false)">+ Create New Customer</button>
            <button class="btn btn-green" onclick="openProductModal()">üì¶ Manage Product Prices</button>
        </div>
    </div>

    <div id="ledgerScreen" style="display:none;">
        <button class="btn" style="background:#636e72; color:white; margin-bottom:10px;" onclick="goBack()">‚Üê Back</button>
        <div class="header" style="background: var(--accent);">
            <h2 id="ledgerTitle" style="margin:0; font-size:16px;"></h2>
            <button id="archiveBtn" class="btn btn-red" style="display:none;" onclick="archiveHistory()">Clear Old History</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th><th>Date</th><th>Prev</th><th>Products</th><th>Total</th><th>Recv</th><th>Rem</th><th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div style="margin-top:20px; display: flex; gap: 10px;">
            <button class="btn btn-blue" onclick="addNewRow()">+ New Row</button>
            <button class="btn btn-green" onclick="saveTable()">Lock & Save</button>
        </div>
    </div>
</div>

<div id="custModal" class="modal"><div class="modal-content">
    <h2 id="custModalTitle">Customer</h2>
    <input type="hidden" id="editOldName">
    <input type="text" id="pName" placeholder="Name" style="width:100%; margin-bottom:10px;">
    <input type="text" id="pPhone" placeholder="Phone" style="width:100%; margin-bottom:10px;">
    <button class="btn btn-blue" style="width:100%" onclick="saveCustomer()">Save</button>
    <button class="btn" style="width:100%; margin-top:5px;" onclick="closeModals()">Cancel</button>
</div></div>

<div id="prodModal" class="modal"><div class="modal-content">
    <h2>Product Catalog</h2>
    <div id="prodListDisplay" style="margin-bottom:15px; max-height:150px; overflow-y:auto;"></div>
    <input type="text" id="newPn" placeholder="Product" style="width:100%; margin-bottom:5px;">
    <input type="number" id="newPp" placeholder="Price" style="width:100%; margin-bottom:5px;">
    <button class="btn btn-blue" style="width:100%" onclick="addProduct()">Add</button>
    <button class="btn" style="width:100%; margin-top:5px;" onclick="closeModals()">Close</button>
</div></div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script>
    
const firebaseConfig = {
  apiKey: "AIzaSyD23EPs0fYy1PBypcFI22t0vZlKix-FXDI",
  authDomain: "wholesale-shop-29c12.firebaseapp.com",
  projectId: "wholesale-shop-29c12",
  storageBucket: "wholesale-shop-29c12.firebasestorage.app",
  messagingSenderId: "154359734424",
  appId: "1:154359734424:web:6592f17ea26a8af79170ed",
  measurementId: "G-GVX8Q1EJ7S"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const currentOwner = sessionStorage.getItem('activeUser');
    let activeCustomer = "";
    let productPrices = {};

    function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
    function openProductModal() { document.getElementById('prodModal').style.display='block'; renderProdCatalog(); }
    function openCustModal(isEdit, name="", phone="") {
        document.getElementById('custModal').style.display='block';
        document.getElementById('editOldName').value = isEdit ? name : "";
        document.getElementById('pName').value = name;
        document.getElementById('pPhone').value = phone;
    }

    // --- NAVIGATION ---
    async function loadCustomers() {
        document.getElementById('ownerDisplay').innerText = currentOwner;
        const main = await db.collection("wholesale_data").doc(currentOwner).get();
        if(main.exists) productPrices = main.data().products || {};

        const list = document.getElementById('customerList');
        const snap = await db.collection("wholesale_data").doc(currentOwner).collection("customers").get();
        list.innerHTML = "";
        snap.forEach(doc => {
            const d = doc.data();
            list.innerHTML += `<div class="customer-card">
                <div style="font-weight:bold; font-size:18px;">${doc.id}</div>
                <div style="font-size:12px; color:gray; margin-bottom:10px;">${d.phone || ''}</div>
                <button class="btn btn-blue" onclick="openLedger('${doc.id}')">Ledger</button>
                <button class="btn" style="background:#f1c40f" onclick="openCustModal(true, '${doc.id}', '${d.phone}')">Edit</button>
            </div>`;
        });
    }

    async function openLedger(name) {
        activeCustomer = name;
        document.getElementById('selectionScreen').style.display = 'none';
        document.getElementById('ledgerScreen').style.display = 'block';
        document.getElementById('ledgerTitle').innerText = name;
        loadTable();
    }

    // --- TABLE LOGIC ---
    async function loadTable() {
        const table = document.getElementById("tableBody");
        table.innerHTML = "";
        const doc = await db.collection("wholesale_data").doc(currentOwner).collection("customers").doc(activeCustomer).get();
        if(doc.exists) {
            const rows = doc.data().rows || [];
            rows.forEach(r => addNewRow(r, true));
            
            // SHOW ARCHIVE BUTTON IF 30+ ROWS & BALANCE IS 0
            if(rows.length > 30 && parseFloat(rows[rows.length-1].rem) === 0) {
                document.getElementById('archiveBtn').style.display = 'block';
            }
        }
    }

    function addNewRow(data = null, isLocked = false) {
        const table = document.getElementById("tableBody");
        const id = table.rows.length + 1;
        const row = table.insertRow();
        let prev = 0;
        if(!data && table.rows.length > 1) {
            prev = table.rows[table.rows.length-2].cells[6].innerText;
        }

        let prodHTML = `<div style="min-width:150px;">`;
        for(let p in productPrices) {
            const isChecked = (data && data.prod_list && data.prod_list.includes(p)) ? 'checked' : '';
            prodHTML += `<label class="prod-tag"><input type="checkbox" value="${p}" data-price="${productPrices[p]}" onchange="updateRowTotal(${id})" ${isChecked} ${isLocked ? 'disabled' : ''}> ${p}</label>`;
        }
        prodHTML += `</div>`;

        const canDelete = !isLocked || (data && parseFloat(data.rem) === 0);

        row.innerHTML = `
            <td>${id}</td>
            <td>${data ? data.date : new Date().toLocaleDateString()}</td>
            <td id="prev_${id}">${data ? data.prev : prev}</td>
            <td>${prodHTML}</td>
            <td><input type="number" id="a_${id}" oninput="calc(${id})" value="${data ? data.amt : ''}" ${isLocked ? 'readonly' : ''}></td>
            <td><input type="number" id="r_${id}" oninput="calc(${id})" value="${data ? data.rec : ''}" ${isLocked ? 'readonly' : ''}></td>
            <td id="rem_${id}" style="font-weight:bold">${data ? data.rem : '0'}</td>
            <td>${canDelete ? `<button class="btn btn-red" onclick="delRow(this, ${id})">Del</button>` : `<span style="font-size:10px;color:green">Locked</span>`}</td>
        `;
    }

    function updateRowTotal(id) {
        let total = 0;
        const boxes = document.getElementById(`tableBody`).rows[id-1].querySelectorAll('input:checked');
        boxes.forEach(box => total += parseFloat(box.getAttribute('data-price')));
        document.getElementById(`a_${id}`).value = total > 0 ? total : '';
        calc(id);
    }

    function calc(id) {
        const p = parseFloat(document.getElementById(`prev_${id}`).innerText) || 0;
        const a = parseFloat(document.getElementById(`a_${id}`).value) || 0;
        const r = parseFloat(document.getElementById(`r_${id}`).value) || 0;
        document.getElementById(`rem_${id}`).innerText = (p + a - r).toFixed(2);
    }

    async function saveTable() {
        let rows = [];
        const tableRows = document.getElementById("tableBody").rows;
        
        for(let r of tableRows) {
            const id = r.cells[0].innerText;
            const selected = Array.from(r.querySelectorAll('input:checked')).map(i => i.value);
            const amt = document.getElementById(`a_${id}`).value;
            
            // VALIDATION: STOP EMPTY SAVES
            if(selected.length === 0 && !amt) {
                alert("Row " + id + " is empty. Please select a product or enter an amount.");
                return;
            }

            rows.push({
                date: r.cells[1].innerText,
                prev: document.getElementById(`prev_${id}`).innerText,
                prod_list: selected,
                amt: amt,
                rec: document.getElementById(`r_${id}`).value,
                rem: document.getElementById(`rem_${id}`).innerText
            });
        }
        await db.collection("wholesale_data").doc(currentOwner).collection("customers").doc(activeCustomer).update({rows: rows});
        alert("Synced & Locked!");
        loadTable();
    }

    async function archiveHistory() {
        if(confirm("Remaining Balance is 0 and history is long. Clear all old rows and start fresh?")) {
            await db.collection("wholesale_data").doc(currentOwner).collection("customers").doc(activeCustomer).update({rows: []});
            loadTable();
        }
    }

    function delRow(btn, id) { btn.parentElement.parentElement.remove(); saveTable(); }
    function goBack() { location.reload(); }
    function logout() { sessionStorage.clear(); window.location.href="index.html"; }
    window.onload = loadCustomers;
</script>
</body>
</html>