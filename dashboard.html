<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale Management - Cloud Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: auto; }
        .header { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; border-top: 5px solid #007bff; }
        
        /* Customer Grid Styling */
        .customer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .customer-card { background: white; padding: 25px; border-radius: 10px; border: 1px solid #ddd; text-align: center; cursor: pointer; transition: 0.3s; font-weight: bold; color: #007bff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .customer-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,123,255,0.2); background: #007bff; color: white; }
        
        /* Table Styling */
        table { width: 100%; background: #fff; border-collapse: collapse; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background: #333; color: white; }
        input { width: 90%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Buttons */
        .controls { background: white; padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .btn-add { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-save { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-back { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 10px; }
        .status-saved { color: #28a745; font-weight: bold; display: none; margin-left: 10px; }
    </style>
</head>
<body>

<div class="container">
    
    <div id="customerSelectionScreen">
        <div class="header">
            <h2>Business Manager</h2>
            <p>Welcome, Owner: <b id="ownerDisplay">Loading...</b></p>
        </div>

        <h3>Select a Customer File:</h3>
        <div id="customerList" class="customer-grid">
            </div>

        <div class="controls">
            <input type="text" id="newCustomerName" placeholder="Enter New Customer Name (e.g. Jawad)">
            <button onclick="addNewCustomer()" class="btn-add">+ Create New File</button>
        </div>
    </div>

    <div id="ledgerScreen" style="display:none;">
        <button class="btn-back" onclick="backToCustomers()">← Back to Customer List</button>
        
        <div class="header">
            <h2 id="currentCustomerTitle">Customer Ledger</h2>
            <p>Managing daily records for this customer.</p>
        </div>

        <table id="excelTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Date</th>
                    <th>Previous Income</th>
                    <th>Product Detail</th>
                    <th>Product Amount</th>
                    <th>Received Amount</th>
                    <th>Remaining Balance</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>

        <div class="controls">
            <button class="btn-add" onclick="addNewRow()">+ Add New Row</button>
            <button class="btn-save" onclick="saveTableData()">Save & Sync Cloud</button>
            <span id="saveStatus" class="status-saved">✔ Data Saved Successfully!</span>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>

<script>
    // 1. CONFIGURATION: Paste your actual keys from Firebase Project Settings here
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyD23EPs0fYy1PBypcFI22t0vZlKix-FXDI",
  authDomain: "wholesale-shop-29c12.firebaseapp.com",
  projectId: "wholesale-shop-29c12",
  storageBucket: "wholesale-shop-29c12.firebasestorage.app",
  messagingSenderId: "154359734424",
  appId: "1:154359734424:web:6592f17ea26a8af79170ed",
  measurementId: "G-GVX8Q1EJ7S"
};

    // Initialize
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let rowCount = 0;
    const currentOwner = sessionStorage.getItem('activeUser') || "Guest";
    let currentCustomerFile = ""; 

    // Helper: Standard Date (Forces same format on all devices)
    function getUniversalDate() {
        const d = new Date();
        return d.getFullYear() + "-" + (d.getMonth() + 1).toString().padStart(2, '0') + "-" + d.getDate().toString().padStart(2, '0');
    }

    // --- NAVIGATION LOGIC ---

    async function loadCustomerList() {
        document.getElementById('ownerDisplay').innerText = currentOwner;
        const listDiv = document.getElementById('customerList');
        listDiv.innerHTML = "Checking files...";

        // Path: wholesale_data -> [OwnerName] -> customers (Sub-collection)
        const snapshot = await db.collection("wholesale_data").doc(currentOwner).collection("customers").get();
        
        listDiv.innerHTML = "";
        if (snapshot.empty) {
            listDiv.innerHTML = "<p>No customer files found. Create your first one below!</p>";
        }

        snapshot.forEach((doc) => {
            const name = doc.id;
            const card = document.createElement('div');
            card.className = "customer-card";
            card.innerText = name;
            card.onclick = () => openLedger(name);
            listDiv.appendChild(card);
        });
    }

    async function addNewCustomer() {
        const name = document.getElementById('newCustomerName').value.trim();
        if(!name) return alert("Please enter a name");

        // Creates a document in the customers sub-collection
        await db.collection("wholesale_data").doc(currentOwner).collection("customers").doc(name).set({ rows: [] });
        document.getElementById('newCustomerName').value = "";
        loadCustomerList(); 
    }

    async function openLedger(customerName) {
        currentCustomerFile = customerName;
        document.getElementById('customerSelectionScreen').style.display = 'none';
        document.getElementById('ledgerScreen').style.display = 'block';
        document.getElementById('currentCustomerTitle').innerText = "Customer File: " + customerName;
        loadTableData(); 
    }

    function backToCustomers() {
        document.getElementById('customerSelectionScreen').style.display = 'block';
        document.getElementById('ledgerScreen').style.display = 'none';
        loadCustomerList();
    }

    // --- DATA LOGIC ---

    async function loadTableData() {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = ""; 
        rowCount = 0;

        const doc = await db.collection("wholesale_data").doc(currentOwner).collection("customers").doc(currentCustomerFile).get();
        
        if (doc.exists) {
            const data = doc.data().rows || [];
            data.forEach(item => addNewRow(item));

            const today = getUniversalDate();
            const todayExists = data.some(row => row.date === today);

            if (!todayExists && data.length > 0) {
                const lastEntry = data[data.length - 1];
                alert("New Day! Carrying over balance for " + currentCustomerFile);
                addNewRow({
                    date: today, prev: lastEntry.rem, prod: '', amt: '', rec: '', rem: lastEntry.rem
                });
                saveTableData();
            }
        }
    }

    async function saveTableData() {
        let dataArray = [];
        const rows = document.getElementById("tableBody").rows;
        
        for (let i = 0; i < rows.length; i++) {
            const id = rows[i].cells[0].innerText;
            dataArray.push({
                date: rows[i].cells[1].innerText,
                prev: document.getElementById(`prev_${id}`).innerText,
                prod: document.getElementById(`prod_${id}`).value,
                amt: document.getElementById(`amt_${id}`).value,
                rec: document.getElementById(`rec_${id}`).value,
                rem: document.getElementById(`rem_${id}`).innerText
            });
        }

        await db.collection("wholesale_data").doc(currentOwner).collection("customers").doc(currentCustomerFile).set({ rows: dataArray });
        
        document.getElementById('saveStatus').style.display = 'inline';
        setTimeout(() => { document.getElementById('saveStatus').style.display = 'none'; }, 3000);
    }

    function calculate(id) {
        const prev = parseFloat(document.getElementById(`prev_${id}`).innerText) || 0;
        const amt = parseFloat(document.getElementById(`amt_${id}`).value) || 0;
        const rec = parseFloat(document.getElementById(`rec_${id}`).value) || 0;
        document.getElementById(`rem_${id}`).innerText = (prev + amt - rec).toFixed(2);
    }

    function addNewRow(savedData = null) {
        rowCount++;
        const table = document.getElementById("tableBody");
        const row = table.insertRow();
        const today = getUniversalDate();
        
        let prevVal = 0;
        if (!savedData && table.rows.length > 1) {
            const prevRow = table.rows[table.rows.length - 2];
            // Cell 6 is the 'Remaining' column
            prevVal = prevRow.cells[6].innerText;
        }

        row.innerHTML = `
            <td>${rowCount}</td>
            <td>${savedData ? savedData.date : today}</td>
            <td id="prev_${rowCount}">${savedData ? savedData.prev : prevVal}</td>
            <td><input type="text" id="prod_${rowCount}" value="${savedData ? savedData.prod : ''}"></td>
            <td><input type="number" id="amt_${rowCount}" oninput="calculate(${rowCount})" value="${savedData ? savedData.amt : ''}"></td>
            <td><input type="number" id="rec_${rowCount}" oninput="calculate(${rowCount})" value="${savedData ? savedData.rec : ''}"></td>
            <td id="rem_${rowCount}" style="font-weight:bold">${savedData ? savedData.rem : '0'}</td>
            <td><button onclick="this.parentElement.parentElement.remove(); saveTableData();" style="color:red; border:none; background:none; cursor:pointer; font-weight:bold;">Delete</button></td>
        `;
    }

    window.onload = loadCustomerList;
</script>

</body>
</html>